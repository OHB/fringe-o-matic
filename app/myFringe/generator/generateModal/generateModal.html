<div class="modal-header">
    <h3 class="modal-title" ng-if="! proposed">
        Generating Schedule...
    </h3>
    <h3 class="modal-title" ng-if="proposed">
        Review Schedule
    </h3>
</div>
<div class="modal-body">
    <div ng-if="! proposed">
        <p>This may take a few seconds or a few minutes.</p>
        <p class="well">It may not be possible to see all of the shows you want.</p>
        <hr />
        <p>
            <small>
                <strong>Progress</strong>
                <em class="pull-right">
                    {{currentGeneration && moment.duration(timeRemaining).humanize() + ' remaining' || 'calculating...'}}
                </em>
            </small>
            <uib-progressbar
                    class="progress-striped active"
                    max="idealFitness"
                    value="progress"
                    type="primary"></uib-progressbar>
        </p>
    </div>
    <div class="row">
        <div class="col-md-3" ng-repeat="desire in ['4', '3', '2', '1']">
            <small>
                <rating desire="desire"></rating>
                <em ng-if="userData.settings.displaySchedulerStats && !proposed">({{desireFitnessPoints[desire]}} points)</em>
                <em class="pull-right">{{progressByDesire[desire]}}/{{progressByDesireMax[desire]}}</em>
            </small>
            <uib-progressbar
                    class="progress active"
                    max="progressByDesireMax[desire]"
                    value="progressByDesire[desire]"
                    animate="true"
                    type="{{getProgressType(progressByDesire[desire], progressByDesireMax[desire])}}">
                {{progressByDesire[desire]}}/{{progressByDesireMax[desire]}}
            </uib-progressbar>
        </div>
    </div>
    <div ng-if="! proposed && userData.settings.displaySchedulerStats">
        <small>
            <div class="row">
                <div class="col-md-3">
                    <strong>Generation</strong><br />
                    {{currentGeneration | number}}/{{generationCount | number}}
                </div>
                <div class="col-md-3"><strong>Schedules Tested</strong><br />
                    {{currentGeneration * populationSize | number}}/{{populationSize * generationCount | number}}
                </div>
                <div class="col-md-3">
                    <strong>Current Best</strong><br />
                    {{bestFitness - bestExtraPoints | number}}/{{idealFitness | number}} (+{{bestExtraPoints}} xp)
                </div>
                <div class="col-md-3">
                    <strong>Current Worst</strong><br />
                    {{worstFitness | number}}
                </div>
            </div>
            <br />
            <p>This tool uses a custom <a href="https://en.wikipedia.org/wiki/Genetic_algorithm">genetic algorithm</a> running in a WebWorker to find a schedule.<br />
                The population size ({{populationSize|number}}) and number of generations ({{generationCount|number}}) is proportional to the number of shows that need placed.</p>
            <p>The crossover rate is {{crossoverRate}} and uses a two-point crossover with parents chosen by rank selection.<br/>
                The mutation rate is {{mutationRate}} and makes 1 or 2 random changes to a schedule.</p>
            <p>Each schedule is scored giving points for every show in the schedule. Higher interest shows get more points.<br />
                Extra points (xp) are awarded when adjacent shows are in nearby venues.</p>
        </small>
    </div>
    <div ng-if="proposed">
        <p>Here is the schedule we put together for you. To keep this, click <strong>Save</strong> at the bottom of this window. If you want generate another schedule, click <strong>Try Again</strong>.</p>
        <table class="table">
            <thead>
            <tr>
                <th>Date/Time</th>
                <th>Show/Venue</th>
                <th>Desire</th>
                <th>Accept?</th>
            </tr>
            </thead>
            <tbody>
            <tr ng-repeat="pId in sortedPerformances" ng-if="proposed.indexOf(pId) > -1" ng-init="performance = performances[pId]">
                <td nowrap="nowrap"><strong>{{moment(performance.start, 'X').format('ddd, MMM Do')}}</strong><br />
                    {{moment(performance.start, 'X').format('h:mm a')}} - {{moment(performance.stop, 'X').format('h:mm a')}}</td>
                <td><strong>{{shows[performance.show].name}}</strong><br />
                    <span class="label label-venue-default label-venue-{{shows[performance.show].venue}}">
                            {{venues[shows[performance.show].venue].name}}
                        </span>
                </td>
                <td nowrap style="vertical-align: middle">
                    <interest show-id="performance.show"></interest>
                </td>
                <td ng-if="uiap(pId)" style="vertical-align: middle" nowrap>
                    <button class="btn" disabled>
                        <span class="glyphicon glyphicon-thumbs-down"></span>
                    </button>
                    <button class="btn btn-success" disabled>
                        <span class="glyphicon glyphicon-thumbs-up"></span>
                    </button>
                </td>
                <td nowrap ng-if="! uiap(pId)" style="vertical-align: middle">
                    <button class="btn" ng-class="{'btn-danger': !accept[pId]}" ng-click="accept[pId]=false">
                        <span class="glyphicon glyphicon-thumbs-down"></span>
                    </button>
                    <button class="btn" ng-class="{'btn-success': accept[pId]}" ng-click="accept[pId]=true">
                        <span class="glyphicon glyphicon-thumbs-up"></span>
                    </button>
                </td>
            </tr>
            </tbody>
        </table>
        <hr />
        <p>Here are the shows we were unable to fit into the schedule:</p>
        <table class="table">
            <thead>
            <tr>
                <th>Show</th>
                <th>Desire</th>
            </tr>
            </thead>
            <tbody>
            <tr ng-repeat="showId in unscheduled">
                <td>{{shows[showId].name}}</td>
                <td>
                    <interest show-id="showId"></interest>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
</div>
<div class="modal-footer" ng-if="! proposed">
    <button class="btn pull-left btn-default" bs-tooltip="{title: 'Stats for nerds'}" data-placement="right" ng-model="userData.settings.displaySchedulerStats" bs-checkbox>
        <i class="glyphicon glyphicon-dashboard"></i>
    </button>
    <button class="btn btn-warning" type="button" ng-click="restart()" ng-disabled="done">Restart</button>
    <button class="btn btn-danger" type="button" ng-click="stop()" ng-disabled="done">Stop</button>
</div>
<div class="modal-footer" ng-if="proposed">
    <button class="btn btn-success" type="button" ng-click="save()">Save</button>
    <button class="btn btn-primary" type="button" ng-click="start()">Try Again</button>
    <button class="btn btn-danger" type="button" ng-click="close()">Discard</button>
</div>